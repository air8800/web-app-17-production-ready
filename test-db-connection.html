<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Database Connection Test</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #4CAF50;
            padding-bottom: 10px;
        }
        .status {
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        button {
            background: #4CAF50;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover {
            background: #45a049;
        }
        button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        pre {
            background: #f4f4f4;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            max-height: 400px;
        }
        .test-section {
            margin: 30px 0;
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
        }
        .test-section h2 {
            color: #4CAF50;
            margin-top: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîå Supabase Database Connection Test</h1>

        <div class="test-section">
            <h2>1. Connection Status</h2>
            <div id="connection-status" class="status info">Testing connection...</div>
        </div>

        <div class="test-section">
            <h2>2. Print Jobs Table Structure</h2>
            <button onclick="checkTableStructure()">Check Table Structure</button>
            <div id="structure-result"></div>
        </div>

        <div class="test-section">
            <h2>3. Verify pages_per_sheet Column</h2>
            <button onclick="verifyColumn()">Verify Column</button>
            <div id="column-result"></div>
        </div>

        <div class="test-section">
            <h2>4. Test Insert with N-up Data</h2>
            <button onclick="testInsert()">Test Insert</button>
            <button onclick="clearTestData()">Clear Test Data</button>
            <div id="insert-result"></div>
        </div>

        <div class="test-section">
            <h2>5. Recent Print Jobs (Last 10)</h2>
            <button onclick="fetchRecentJobs()">Fetch Recent Jobs</button>
            <div id="jobs-result"></div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://nnqqdlrarfdjmyjsxxrw.supabase.co'
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5ucXFkbHJhcmZkam15anN4eHJ3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDcwMDI2MDQsImV4cCI6MjA2MjU3ODYwNH0.5E4Mbxtl4VlsKk71o6usEfwGjpHAaE9QAegL9LYYsWw'

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

        // Test connection on load
        async function testConnection() {
            const statusDiv = document.getElementById('connection-status')
            try {
                const { data, error } = await supabase.from('print_jobs').select('count', { count: 'exact', head: true })

                if (error) {
                    statusDiv.className = 'status error'
                    statusDiv.innerHTML = `‚ùå Connection Failed: ${error.message}`
                } else {
                    statusDiv.className = 'status success'
                    statusDiv.innerHTML = '‚úÖ Connected Successfully to Supabase!'
                }
            } catch (err) {
                statusDiv.className = 'status error'
                statusDiv.innerHTML = `‚ùå Connection Error: ${err.message}`
            }
        }

        async function checkTableStructure() {
            const resultDiv = document.getElementById('structure-result')
            resultDiv.innerHTML = '<div class="status info">Checking table structure...</div>'

            try {
                const { data, error } = await supabase.rpc('get_table_columns', { table_name: 'print_jobs' })

                if (error) {
                    // Fallback: Try to get a single row to see structure
                    const { data: sampleData, error: sampleError } = await supabase
                        .from('print_jobs')
                        .select('*')
                        .limit(1)

                    if (sampleError) {
                        resultDiv.innerHTML = `<div class="status error">‚ùå Error: ${sampleError.message}</div>`
                    } else {
                        const columns = sampleData.length > 0 ? Object.keys(sampleData[0]) : []
                        resultDiv.innerHTML = `
                            <div class="status success">‚úÖ Table columns found:</div>
                            <pre>${JSON.stringify(columns, null, 2)}</pre>
                            ${columns.includes('pages_per_sheet') ?
                                '<div class="status success">‚úÖ pages_per_sheet column EXISTS!</div>' :
                                '<div class="status error">‚ùå pages_per_sheet column NOT FOUND!</div>'
                            }
                        `
                    }
                } else {
                    resultDiv.innerHTML = `<div class="status success">‚úÖ Table structure:</div><pre>${JSON.stringify(data, null, 2)}</pre>`
                }
            } catch (err) {
                resultDiv.innerHTML = `<div class="status error">‚ùå Error: ${err.message}</div>`
            }
        }

        async function verifyColumn() {
            const resultDiv = document.getElementById('column-result')
            resultDiv.innerHTML = '<div class="status info">Verifying pages_per_sheet column...</div>'

            try {
                // Try to select with pages_per_sheet column
                const { data, error } = await supabase
                    .from('print_jobs')
                    .select('id, pages_per_sheet')
                    .limit(1)

                if (error) {
                    if (error.message.includes('pages_per_sheet')) {
                        resultDiv.innerHTML = `
                            <div class="status error">‚ùå Column does NOT exist!</div>
                            <p>You need to apply the migration first.</p>
                            <pre>${error.message}</pre>
                        `
                    } else {
                        resultDiv.innerHTML = `<div class="status error">‚ùå Error: ${error.message}</div>`
                    }
                } else {
                    resultDiv.innerHTML = `
                        <div class="status success">‚úÖ pages_per_sheet column EXISTS and is accessible!</div>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `
                }
            } catch (err) {
                resultDiv.innerHTML = `<div class="status error">‚ùå Error: ${err.message}</div>`
            }
        }

        async function testInsert() {
            const resultDiv = document.getElementById('insert-result')
            resultDiv.innerHTML = '<div class="status info">Testing insert with N-up data...</div>'

            try {
                // First, get a shop ID
                const { data: shops, error: shopError } = await supabase
                    .from('shops')
                    .select('id')
                    .limit(1)

                if (shopError || !shops || shops.length === 0) {
                    resultDiv.innerHTML = `<div class="status error">‚ùå No shops found. Please create a shop first.</div>`
                    return
                }

                const testData = {
                    shop_id: shops[0].id,
                    filename: 'test-nup-document.pdf',
                    file_url: 'https://example.com/test.pdf',
                    copies: 1,
                    paper_size: 'A4',
                    color_mode: 'BW',
                    print_type: 'Single',
                    pages_per_sheet: 2, // Testing N-up = 2
                    customer_name: 'Test Customer',
                    customer_email: 'test@example.com',
                    customer_phone: '1234567890',
                    total_cost: 10.00
                }

                const { data, error } = await supabase
                    .from('print_jobs')
                    .insert(testData)
                    .select()

                if (error) {
                    resultDiv.innerHTML = `<div class="status error">‚ùå Insert failed: ${error.message}</div>`
                } else {
                    resultDiv.innerHTML = `
                        <div class="status success">‚úÖ Test insert successful!</div>
                        <p><strong>Inserted data with pages_per_sheet = 2</strong></p>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `
                }
            } catch (err) {
                resultDiv.innerHTML = `<div class="status error">‚ùå Error: ${err.message}</div>`
            }
        }

        async function clearTestData() {
            const resultDiv = document.getElementById('insert-result')
            resultDiv.innerHTML = '<div class="status info">Clearing test data...</div>'

            try {
                const { data, error } = await supabase
                    .from('print_jobs')
                    .delete()
                    .eq('customer_name', 'Test Customer')
                    .select()

                if (error) {
                    resultDiv.innerHTML = `<div class="status error">‚ùå Delete failed: ${error.message}</div>`
                } else {
                    resultDiv.innerHTML = `
                        <div class="status success">‚úÖ Test data cleared!</div>
                        <p>Deleted ${data.length} test record(s)</p>
                    `
                }
            } catch (err) {
                resultDiv.innerHTML = `<div class="status error">‚ùå Error: ${err.message}</div>`
            }
        }

        async function fetchRecentJobs() {
            const resultDiv = document.getElementById('jobs-result')
            resultDiv.innerHTML = '<div class="status info">Fetching recent jobs...</div>'

            try {
                const { data, error } = await supabase
                    .from('print_jobs')
                    .select('id, filename, pages_per_sheet, customer_name, created_at, status')
                    .order('created_at', { ascending: false })
                    .limit(10)

                if (error) {
                    resultDiv.innerHTML = `<div class="status error">‚ùå Error: ${error.message}</div>`
                } else {
                    if (data.length === 0) {
                        resultDiv.innerHTML = '<div class="status info">No print jobs found in database.</div>'
                    } else {
                        const hasNupColumn = data[0].hasOwnProperty('pages_per_sheet')
                        resultDiv.innerHTML = `
                            <div class="status success">‚úÖ Found ${data.length} recent job(s)</div>
                            ${hasNupColumn ?
                                '<div class="status success">‚úÖ pages_per_sheet data is present!</div>' :
                                '<div class="status error">‚ùå pages_per_sheet column missing!</div>'
                            }
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        `
                    }
                }
            } catch (err) {
                resultDiv.innerHTML = `<div class="status error">‚ùå Error: ${err.message}</div>`
            }
        }

        // Test connection on page load
        testConnection()
    </script>
</body>
</html>
